<!doctype html>
<html lang="en" class="h-full bg-[#0b0b10] text-zinc-100">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BSSC Token Deployer (no eth_getBlockByNumber)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
  <style>
    :root{ --stroke:rgba(255,255,255,.08); --ink:#e5e7eb; }
    .shell{ max-width:980px; margin:0 auto; padding:32px 16px }
    .card{ background:#10111a; border:1px solid var(--stroke); border-radius:16px; padding:20px; box-shadow:0 10px 24px rgba(0,0,0,.35) }
    .field{ width:100%; background:#0f1117; border:1px solid var(--stroke); border-radius:12px; padding:12px 14px; color:var(--ink); outline:none }
    .primary{ background-image:linear-gradient(135deg,#6d28d9,#4f46e5); color:white; font-weight:800; border-radius:12px; padding:12px 18px; box-shadow:0 10px 26px rgba(79,70,229,.35) }
    .ghost{ background:#ffffff10; border:1px solid var(--stroke); color:var(--ink); border-radius:12px; padding:10px 14px }
    .pill{ display:inline-flex; align-items:center; gap:8px; border-radius:9999px; padding:6px 10px; font-weight:700; border:1px solid var(--stroke) }
    .ok{ background:#052e2b; color:#86efac; border-color:#134e4a }
    .err{ background:#421919; color:#fecaca; border-color:#7f1d1d }
    .row{ display:grid; grid-template-columns:110px 1fr; gap:10px; padding:10px 12px; border-bottom:1px solid var(--stroke) }
    .tag{ font-size:11px; padding:2px 8px; border-radius:9999px; font-weight:700 }
    .tag.ok{ background:#064e3b; color:#6ee7b7 }
    .tag.err{ background:#5f1b1b; color:#fecaca }
    #logs{ min-height:120px }
  </style>
</head>
<body>
  <main class="shell space-y-6">
    <header class="flex items-center justify-between">
      <div class="text-2xl font-extrabold tracking-tight">BSSC Token Deployer</div>
      <div id="health" class="pill ok hidden">
        <span class="w-2 h-2 rounded-full bg-emerald-400"></span>HEALTHY
      </div>
    </header>

    <!-- Wallet -->
    <section class="card space-y-3">
      <div class="text-xs uppercase text-zinc-400">Your wallet</div>
      <div class="row">
        <div class="text-zinc-500">Address</div>
        <div class="flex items-center justify-between gap-3">
          <div id="addr" class="font-mono truncate">—</div>
          <div class="flex gap-2">
            <button id="copyAddr" class="ghost">Copy</button>
            <button id="check" class="ghost">Check BNB</button>
            <button id="recover" class="primary">Recover</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="text-zinc-500">Private key</div>
        <div class="flex items-center justify-between gap-3">
          <input id="pk" class="field font-mono" placeholder="0x… (64 hex)"/>
          <button id="copyPk" class="ghost">Copy</button>
        </div>
      </div>
      <div class="row">
        <div class="text-zinc-500">BNB Balance</div>
        <div><span id="bal" class="font-mono">—</span> <span class="text-zinc-400">BNB</span></div>
      </div>
    </section>

    <!-- Deploy -->
    <section class="card space-y-3">
      <div class="text-xs uppercase text-zinc-400">Deploy new ERC-20</div>
      <div class="grid md:grid-cols-2 gap-3">
        <input id="name" class="field" placeholder="Token name (e.g., Demo Token)"/>
        <input id="symbol" class="field" placeholder="Symbol (e.g., DMO)"/>
      </div>
      <div class="text-sm text-zinc-400">Decimals = <b>9</b>, Initial Supply = <b>1,000,000</b> (minted to your wallet)</div>
      <div id="inlineErr" class="text-rose-300 text-sm hidden"></div>
      <div class="grid md:grid-cols-2 gap-3">
        <textarea id="bytecode" class="field font-mono" rows="6" placeholder="Paste Remix bytecode object (0x...) here"></textarea>
        <textarea id="abi" class="field font-mono" rows="6" placeholder="(Optional) Paste ABI with constructor if different. Leave empty to use default constructor ABI."></textarea>
      </div>
      <div class="flex items-center gap-2">
        <button id="deploy" class="primary">Deploy</button>
      </div>
    </section>

    <!-- Activity -->
    <section class="card space-y-2">
      <div class="flex items-center justify-between">
        <div class="text-xs uppercase text-zinc-400">Activity</div>
        <button id="clear" class="ghost">Clear</button>
      </div>
      <div id="logs" class="space-y-1"></div>
    </section>
  </main>

<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js";

  // ===== Config =====
  const RPC       = "https://bssc-rpc.bssc.live";
  const CHAIN_ID  = 16979;
  const DECIMALS  = 9n;
  const SUPPLY_H  = 1_000_000n;  // human (×10^decimals はコントラクト内で実施)
  const $ = id => document.getElementById(id);

  const logs = $("logs"), balEl = $("bal"), addrEl = $("addr"), pkEl = $("pk"),
        health = $("health"), inlineErr = $("inlineErr");

  const log = (m,t="INFO")=>{
    const row=document.createElement("div");row.className="row";
    row.innerHTML=`<div><span class="tag ${t==="OK"?"ok":t==="ERR"?"err":""}">${t}</span></div><div class="font-mono break-all">${m}</div>`;
    logs.prepend(row);
  };
  const showErr = m=>{ inlineErr.textContent="✕ "+m; inlineErr.classList.remove("hidden"); };
  const hideErr = ()=>inlineErr.classList.add("hidden");

  // ===== Minimal JSON-RPC helper (only supported methods) =====
  const rpc = async (method, params=[]) => {
    const r = await fetch(RPC, {
      method:"POST", headers:{ "content-type":"application/json" },
      body: JSON.stringify({ jsonrpc:"2.0", id: Date.now(), method, params })
    });
    const j = await r.json();
    if (j.error) throw new Error(j.error.message || JSON.stringify(j.error));
    return j.result;
  };

  // ===== Wallet bootstrap (no provider needed for signing) =====
  let wallet;
  function ensureWallet() {
    const saved = localStorage.getItem("privkey");
    if (saved && /^0x[0-9a-fA-F]{64}$/.test(saved)) {
      wallet = new ethers.Wallet(saved);
      log("Recovered wallet", "OK");
    } else {
      wallet = ethers.Wallet.createRandom();
      localStorage.setItem("privkey", wallet.privateKey);
      log("Generated new wallet", "OK");
    }
    addrEl.textContent = wallet.address;
    pkEl.value = wallet.privateKey;
  }
  ensureWallet();

  $("recover").onclick = ()=>{
    const v = (pkEl.value||"").trim();
    if (!/^0x[0-9a-fA-F]{64}$/.test(v)) { log("Invalid private key", "ERR"); return; }
    wallet = new ethers.Wallet(v);
    localStorage.setItem("privkey", wallet.privateKey);
    addrEl.textContent = wallet.address;
    log("Recovered wallet", "OK");
  };
  $("copyAddr").onclick = async()=>{ await navigator.clipboard.writeText(wallet.address); log("Address copied","OK"); };
  $("copyPk").onclick   = async()=>{ await navigator.clipboard.writeText(wallet.privateKey); log("Private key copied","OK"); };
  $("clear").onclick    = ()=>logs.innerHTML="";

  // ===== Health (without eth_getBlockByNumber) =====
  (async ()=>{
    try{
      const [cid, gp] = await Promise.all([
        rpc("eth_chainId", []),
        rpc("eth_gasPrice", [])
      ]);
      health.classList.remove("hidden");
      log(`RPC OK (chainId ${parseInt(cid,16)}, gas ${(Number(BigInt(gp))/1e9).toFixed(3)} gwei)`,"OK");
    }catch(e){ log("Health check failed: "+(e?.message||e),"ERR"); }
  })();

  // ===== Balance
  $("check").onclick = async()=>{
    try {
      const weiHex = await rpc("eth_getBalance", [wallet.address, "latest"]);
      balEl.textContent = ethers.formatEther(BigInt(weiHex));
      log("Checked BNB balance","OK");
    } catch(e){ log("Check balance error: "+(e?.message||e),"ERR"); }
  };
  $("check").click();

  // ===== Default constructor ABI (constructor(name, symbol, uint8, uint256))
  const DEFAULT_CTOR_ABI = [{
    type:"constructor",
    inputs:[
      {name:"name_",   type:"string"},
      {name:"symbol_", type:"string"},
      {name:"decimals_", type:"uint8"},
      {name:"initialSupplyHuman_", type:"uint256"}
    ]
  }];

  // ===== Deploy flow (no ContractFactory, raw legacy tx)
  $("deploy").onclick = async ()=>{
    hideErr();
    try {
      const name = $("name").value.trim();
      const symbol = $("symbol").value.trim();
      const bytecode = $("bytecode").value.trim();
      const abiText  = $("abi").value.trim();

      if (!name || !symbol) { showErr("Enter name & symbol"); return; }
      if (!/^0x[0-9a-fA-F]+$/.test(bytecode)) { showErr("Paste Remix bytecode object (0x...)"); return; }

      // Interface (use pasted ABI if present, else constructor-only ABI)
      const ctorAbi = abiText ? JSON.parse(abiText) : DEFAULT_CTOR_ABI;
      const iface = new ethers.Interface(ctorAbi);

      // encode constructor (human supply; contract multiplies by 10^decimals)
      const dataCtor = iface.encodeDeploy([name, symbol, Number(DECIMALS), SUPPLY_H]);
      const txData = bytecode + dataCtor.slice(2);

      // gasPrice & nonce (latest only)
      const [gasPriceHex, nonceHex] = await Promise.all([
        rpc("eth_gasPrice", []),
        rpc("eth_getTransactionCount", [wallet.address, "latest"])
      ]);
      const gasPrice = BigInt(gasPriceHex);
      const nonce = parseInt(nonceHex, 16);

      // estimateGas (graceful fallback)
      let gasLimit = 2_000_000n;
      try {
        const est = await rpc("eth_estimateGas", [{ from: wallet.address, data: txData }]);
        gasLimit = BigInt(est) + 50_000n;
      } catch { /* ignore */ }

      // unsigned legacy tx (type:0); do NOT set "to"
      const unsigned = {
        // to: null,
        data: txData,
        gasPrice,
        gasLimit,
        nonce,
        chainId: CHAIN_ID,
        type: 0
      };

      // sign & send
      const signed = await wallet.signTransaction(unsigned);
      const txHash = await rpc("eth_sendRawTransaction", [signed]);
      log(`TX sent: ${txHash}`);

      // wait receipt (poll)
      const deadline = Date.now() + 60_000;
      let receipt = null;
      while (Date.now() < deadline) {
        try {
          receipt = await rpc("eth_getTransactionReceipt", [txHash]);
          if (receipt && receipt.contractAddress) break;
        } catch {}
        await new Promise(r => setTimeout(r, 1500));
      }
      if (!receipt?.contractAddress) {
        showErr("Timeout: receipt not found yet");
        log("Timeout waiting receipt","ERR");
        return;
      }

      // verify code present
      const code = await rpc("eth_getCode", [receipt.contractAddress, "latest"]);
      if (!code || code === "0x") {
        log(`Deployed but code not found yet at ${receipt.contractAddress}`,"ERR");
      } else {
        log(`Deployed at ${receipt.contractAddress}`,"OK");
      }

      // refresh balance
      $("check").click();

    } catch(e) {
      const msg = e?.reason || e?.error?.message || e?.message || String(e);
      showErr(msg);
      log("Deploy error: "+msg,"ERR");
    }
  };
</script>
</body>
</html>
