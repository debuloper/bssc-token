<!doctype html>
<html lang="en" class="h-full bg-[#0b0b10] text-zinc-100">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Token Deployer — micro-bssc-wallet (EVM / BNB)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --stroke:rgba(255,255,255,.06); }
    .shell{ max-width:1100px; margin:0 auto; padding:32px 16px }
    .card{ background:linear-gradient(180deg,#10111a,#0b0b10 65%); border-radius:16px; padding:20px; box-shadow:0 12px 32px rgba(0,0,0,.4); border:1px solid var(--stroke) }
    .primary{ background-image:linear-gradient(135deg,#6d28d9,#4f46e5); color:#fff; border-radius:12px; padding:10px 16px; font-weight:700; box-shadow:0 8px 24px rgba(109,40,217,.35); border:1px solid rgba(255,255,255,.1) }
    .ghost{ background:#ffffff0f; color:#e5e7eb; border-radius:12px; padding:10px 16px; border:1px solid rgba(255,255,255,.1) }
    .field{ width:100%; background:#0f1117; color:#e5e7eb; border:1px solid var(--stroke); border-radius:12px; padding:10px 12px }
    .mono{ font-variant-numeric:tabular-nums }
    .row{ display:flex; gap:12px; flex-wrap:wrap }
    .nav{ display:flex; justify-content:space-between; align-items:center }
    .log-row{ display:grid; grid-template-columns:110px minmax(0,1fr); gap:12px; padding:10px 12px; border-radius:12px; background:#10111a; border:1px solid var(--stroke) }
    .tag{ font-size:11px; padding:2px 8px; border-radius:9999px; font-weight:700 }
    .tag.info{ background:#2a2e6b; color:#c7d2fe } .tag.ok{ background:#0a3c2f; color:#a7f3d0 } .tag.err{ background:#5f1b1b; color:#fecaca }
    .sig{ word-break:break-all; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace }
    #logs{ min-height:120px }
    .modal-back{ position:fixed; inset:0; background:rgba(0,0,0,.6); backdrop-filter:blur(4px); z-index:60; display:none }
    .modal{ max-width:760px; margin:6vh auto; background:#10111a; border:1px solid var(--stroke); border-radius:16px; overflow:hidden }
    .modal-hd{ display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-bottom:1px solid var(--stroke) }
    .modal-bd{ padding:16px 18px }
  </style>
</head>
<body>
  <main class="shell space-y-6">
    <header class="nav">
      <div class="row" style="align-items:center">
        <div style="width:36px;height:36px;border-radius:12px;border:1px solid var(--stroke);
          background:radial-gradient(110% 110% at top left,rgba(109,40,217,.9),rgba(79,70,229,.9))"></div>
        <h1 class="text-xl md:text-2xl font-semibold tracking-tight">Token Deployer — micro-bssc-wallet (EVM)</h1>
      </div>
      <div class="row">
        <button id="ping" class="ghost">Ping</button>
        <a class="ghost" href="https://bssc.live/#faucet" target="_blank" rel="noreferrer">Get Test BNB</a>
      </div>
    </header>

    <!-- Wallet -->
    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div>
          <div class="text-xs uppercase text-zinc-400">Your Wallet</div>
          <div id="addr" class="mono">—</div>
        </div>
        <div id="status" class="tag info">NOT READY</div>
      </div>
      <div class="row mt-3">
        <button id="gen" class="primary">Generate Wallet</button>
        <input id="priv" class="field" placeholder="Private key (0x…)" style="max-width:420px"/>
        <button id="recover" class="ghost">Recover</button>
        <button id="copyAddr" class="ghost">Copy Address</button>
      </div>
      <div class="row mt-3">
        <div>
          <div class="text-xs uppercase text-zinc-400">Balance</div>
          <div id="bal" class="text-2xl font-semibold mono mt-1">— BNB</div>
        </div>
        <button id="check" class="ghost">Check Balance</button>
      </div>
    </section>

    <!-- Deploy -->
    <section class="card space-y-3">
      <div class="text-xs uppercase text-zinc-400">Deploy new ERC-20</div>
      <div class="row">
        <input id="name" class="field" placeholder="Token name (e.g., Demo Token)" style="flex:1;min-width:220px"/>
        <input id="symbol" class="field" placeholder="Symbol (e.g., DMO)" style="width:160px"/>
        <input id="dec" class="field" placeholder="Decimals (e.g., 18)" style="width:140px"/>
        <input id="supply" class="field" placeholder="Initial supply (human, e.g., 1000000)" style="flex:1;min-width:220px"/>
      </div>
      <div class="row">
        <textarea id="abi" rows="6" class="field" placeholder="Paste ERC-20 ABI JSON" style="flex:1;min-width:320px"></textarea>
        <textarea id="bytecode" rows="6" class="field" placeholder="Paste ERC-20 bytecode (0x…)" style="flex:1;min-width:320px"></textarea>
      </div>
      <div class="row">
        <button id="deploy" class="primary">Deploy</button>
        <button id="clearLogs" class="ghost">Clear Logs</button>
      </div>
      <details class="mt-2 text-sm text-zinc-400">
        <summary>Sample Solidity (compile in Remix, then paste ABI & bytecode)</summary>
<pre style="white-space:pre-wrap;line-height:1.3em;margin-top:8px">
/*
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";

contract SimpleToken is ERC20 {
    constructor(string memory name_, string memory symbol_, uint8 decimals_, uint256 initialSupply_) ERC20(name_, symbol_) {
        _mint(msg.sender, initialSupply_ * 10 ** decimals_);
    }
}
*/
</pre>
      </details>
    </section>

    <!-- Manage -->
    <section class="card space-y-3">
      <div class="text-xs uppercase text-zinc-400">Manage ERC-20</div>
      <div class="row">
        <input id="tokAddr" class="field" placeholder="Token address (0x…)" style="flex:1;min-width:280px"/>
        <button id="loadToken" class="ghost">Load</button>
      </div>
      <div class="row">
        <input id="to" class="field" placeholder="Recipient (0x…)" style="flex:1;min-width:280px"/>
        <input id="amt" class="field" placeholder="Amount (human)" style="width:220px"/>
        <button id="sendTok" class="primary">Transfer</button>
      </div>
      <div class="row">
        <div><span class="text-xs uppercase text-zinc-400">Name</span><div id="tName" class="mono">—</div></div>
        <div><span class="text-xs uppercase text-zinc-400">Symbol</span><div id="tSym" class="mono">—</div></div>
        <div><span class="text-xs uppercase text-zinc-400">Decimals</span><div id="tDec" class="mono">—</div></div>
        <div><span class="text-xs uppercase text-zinc-400">Your Token Balance</span><div id="tBal" class="mono">—</div></div>
      </div>
    </section>

    <!-- Activity -->
    <section class="card space-y-3">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="text-xs uppercase text-zinc-400">Activity</div>
        <button id="clear" class="ghost">Clear</button>
      </div>
      <div id="logs" class="space-y-2"></div>
    </section>
  </main>

  <!-- Modal -->
  <div id="txModal" class="modal-back">
    <div class="modal">
      <div class="modal-hd">
        <div style="font-weight:700">Transaction</div>
        <button id="txClose" class="ghost">Close</button>
      </div>
      <div class="modal-bd" id="txBody"></div>
    </div>
  </div>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js";

    const RPC = "https://bssc-rpc.bssc.live";

    async function rpc(method, params = []) {
      const r = await fetch(RPC, {
        method: "POST", headers: { "content-type": "application/json" },
        body: JSON.stringify({ jsonrpc:"2.0", id:Date.now(), method, params })
      });
      const j = await r.json();
      if (j.error) throw new Error(j.error.message || JSON.stringify(j.error));
      return j.result;
    }

    let wallet = null;
    const $ = (id)=>document.getElementById(id);
    function addLog({type="info", msg}){
      const row=document.createElement("div"); row.className="log-row";
      const ts=document.createElement("div"); ts.className="mono text-zinc-400"; ts.textContent=new Date().toLocaleTimeString();
      const body=document.createElement("div");
      const tag=document.createElement("span"); tag.className=`tag ${type==="ok"?"ok":type==="err"?"err":"info"}`; tag.textContent=type.toUpperCase();
      const span=document.createElement("span"); span.className="ml-2"; span.textContent=msg;
      body.appendChild(tag); body.appendChild(span);
      row.appendChild(ts); row.appendChild(body);
      $("logs").prepend(row);
    }

    async function refreshBNB(){
      if (!wallet) return;
      const weiHex = await rpc("eth_getBalance",[wallet.address,"latest"]);
      const bnb = ethers.formatEther(BigInt(weiHex));
      $("bal").textContent = `${bnb} BNB`;
    }

    // Wallet
    $("gen").onclick = ()=> {
      wallet = ethers.Wallet.createRandom();
      $("addr").textContent = wallet.address;
      $("priv").value = wallet.privateKey;
      $("status").className="tag ok"; $("status").textContent="READY";
      addLog({msg:"Wallet generated"});
      refreshBNB();
    };
    $("recover").onclick = ()=>{
      const pk = $("priv").value.trim();
      if (!pk || !pk.startsWith("0x")) return addLog({type:"err", msg:"Invalid private key"});
      wallet = new ethers.Wallet(pk);
      $("addr").textContent = wallet.address;
      $("status").className="tag ok"; $("status").textContent="READY";
      addLog({type:"ok", msg:"Wallet recovered"});
      refreshBNB();
    };
    $("copyAddr").onclick = async ()=>{ const a=$("addr").textContent.trim(); if(a){ await navigator.clipboard.writeText(a); addLog({type:"ok", msg:"Address copied"});} };
    $("check").onclick   = refreshBNB;

    // Ping
    $("ping").onclick = async ()=>{
      try{
        const [blockHex, gasHex] = await Promise.all([
          rpc("eth_blockNumber",[]), rpc("eth_gasPrice",[])
        ]);
        const bn=parseInt(blockHex,16); const gwei = Number(BigInt(gasHex))/1e9;
        addLog({msg:`Ping OK (block ${bn}, gas ${gwei.toFixed(3)} gwei)`});
      }catch(e){ addLog({type:"err", msg:"Ping failed: "+(e.message||e)}); }
    };

    // Modal helpers
    const txModal=$("txModal"), txBody=$("txBody"), txClose=$("txClose");
    txClose.onclick = ()=>{ txModal.style.display="none"; };
    txModal.addEventListener("click",(e)=>{ if(e.target===txModal) txModal.style.display="none"; });

    // Encode constructor data using ABI
    function encodeDeployData(abi, args){
      const iface = new ethers.Interface(abi);
      const encoded = iface.encodeDeploy(args); // 0x...
      return encoded;
    }

    // Raw send helper (with our nonce/gas)
    async function sendSignedTx(unsigned){
      const [gHex, nHex] = await Promise.all([
        rpc("eth_gasPrice",[]),
        rpc("eth_getTransactionCount",[wallet.address,"latest"])
      ]);
      const gasPrice = BigInt(gHex);
      const nonce    = parseInt(nHex,16);

      const tx = {
        to: unsigned.to ?? undefined,
        data: unsigned.data ?? undefined,
        value: unsigned.value ?? 0n,
        gasLimit: unsigned.gasLimit ?? 500000n,
        gasPrice,
        nonce,
        chainId: 16979,
        type: 0
      };
      const signed = await wallet.signTransaction(tx);
      return await rpc("eth_sendRawTransaction",[signed]);
    }

    // Deploy
    $("deploy").onclick = async ()=>{
      try{
        if(!wallet) return addLog({type:"err", msg:"Generate/Recover wallet first"});
        const name = $("name").value.trim();
        const sym  = $("symbol").value.trim();
        const dec  = parseInt($("dec").value.trim() || "18", 10);
        const supH = $("supply").value.trim();
        if(!name || !sym || !supH) return addLog({type:"err", msg:"Enter name, symbol, decimals, initial supply"});
        const abiTxt = $("abi").value.trim();
        const bytecode = $("bytecode").value.trim();
        if(!abiTxt || !bytecode.startsWith("0x")) return addLog({type:"err", msg:"Paste ABI and 0x bytecode"});

        const abi = JSON.parse(abiTxt);
        const initial = ethers.parseUnits(supH, dec);
        const data = bytecode + encodeDeployData(abi, [name, sym, dec, initial]).slice(2);

        const hash = await sendSignedTx({ data, gasLimit: 1_200_000n });
        addLog({type:"info", msg:`Deploy sent: ${hash}`});
        txBody.innerHTML = `<div><strong>Status:</strong> <span class="tag info">SENT</span></div>
          <div class="mt-2"><strong>Hash</strong></div><div class="sig">${hash}</div>`;
        txModal.style.display="block";

        // wait receipt
        let receipt=null, until=Date.now()+120000;
        while(Date.now()<until){
          receipt = await rpc("eth_getTransactionReceipt",[hash]);
          if(receipt && receipt.contractAddress) break;
          await new Promise(r=>setTimeout(r,1500));
        }
        if(receipt && receipt.status==="0x1"){
          addLog({type:"ok", msg:`Deployed at ${receipt.contractAddress}`});
          txBody.innerHTML += `<div class="mt-2"><strong>Contract</strong></div><div class="sig">${receipt.contractAddress}</div>`;
          $("tokAddr").value = receipt.contractAddress;
        }else{
          addLog({type:"err", msg:"Deploy failed or timeout"});
        }
      }catch(e){ addLog({type:"err", msg:"Deploy error: "+(e.message||e)}); }
    };

    // Manage: load metadata & balance
    const erc20 = new ethers.Interface([
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function decimals() view returns (uint8)",
      "function balanceOf(address) view returns (uint256)",
      "function transfer(address,uint256) returns (bool)"
    ]);

    async function callToken(token, data){
      const res = await rpc("eth_call", [{ to: token, data }, "latest"]);
      return res;
    }

    $("loadToken").onclick = async ()=>{
      try{
        const token = $("tokAddr").value.trim();
        if(!token || !token.startsWith("0x")) return addLog({type:"err", msg:"Enter token address"});
        const [n,s,d,b] = await Promise.all([
          callToken(token, erc20.encodeFunctionData("name",[])),
          callToken(token, erc20.encodeFunctionData("symbol",[])),
          callToken(token, erc20.encodeFunctionData("decimals",[])),
          callToken(token, erc20.encodeFunctionData("balanceOf",[wallet.address]))
        ]);
        $("tName").textContent = erc20.decodeFunctionResult("name", n)[0];
        $("tSym").textContent  = erc20.decodeFunctionResult("symbol", s)[0];
        const dec = Number(erc20.decodeFunctionResult("decimals", d)[0]);
        $("tDec").textContent  = String(dec);
        const bal = erc20.decodeFunctionResult("balanceOf", b)[0];
        $("tBal").textContent  = ethers.formatUnits(bal, dec);
        addLog({type:"ok", msg:"Token loaded"});
      }catch(e){ addLog({type:"err", msg:"Load token error: "+(e.message||e)}); }
    };

    $("sendTok").onclick = async ()=>{
      try{
        if(!wallet) return addLog({type:"err", msg:"Generate/Recover wallet first"});
        const token = $("tokAddr").value.trim();
        const to    = $("to").value.trim();
        const amtH  = $("amt").value.trim();
        if(!token || !to || !amtH) return addLog({type:"err", msg:"Enter token address, recipient, amount"});
        // decimals
        const d = await callToken(token, erc20.encodeFunctionData("decimals",[]));
        const dec = Number(erc20.decodeFunctionResult("decimals", d)[0]);
        const amt = ethers.parseUnits(amtH, dec);
        const data = erc20.encodeFunctionData("transfer", [to, amt]);

        const hash = await sendSignedTx({ to: token, data, gasLimit: 120000n, value:0n });
        addLog({type:"info", msg:`Transfer sent: ${hash}`});
        txBody.innerHTML = `<div><strong>Status:</strong> <span class="tag info">SENT</span></div>
          <div class="mt-2"><strong>Hash</strong></div><div class="sig">${hash}</div>`;
        txModal.style.display="block";

        // wait receipt
        let receipt=null, until=Date.now()+60000;
        while(Date.now()<until){
          receipt = await rpc("eth_getTransactionReceipt",[hash]);
          if(receipt && receipt.blockNumber) break;
          await new Promise(r=>setTimeout(r,1500));
        }
        if(receipt && receipt.status==="0x1"){
          addLog({type:"ok", msg:"Transfer confirmed"});
          // refresh token balance
          const b = await callToken(token, erc20.encodeFunctionData("balanceOf",[wallet.address]));
          $("tBal").textContent = ethers.formatUnits(erc20.decodeFunctionResult("balanceOf", b)[0], dec);
        }else{
          addLog({type:"err", msg:"Transfer failed or timeout"});
        }
      }catch(e){ addLog({type:"err", msg:"Send token error: "+(e.message||e)}); }
    };

    // misc
    $("clear").onclick = ()=>{ $("logs").innerHTML=""; };
    $("clearLogs").onclick = ()=>{ $("logs").innerHTML=""; };
  </script>
</body>
</html>
